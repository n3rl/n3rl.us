<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>Hanzi</title>
  <style>
    #canvas {
      border: 1px solid black;
      touch-action: none;
    }
    #controls {
      margin-top: 10px;
    }
	
	#wrapper {
  position: relative;
  width: 300px;
  height: 300px;
}

.button-grid {
  width: 200px;
  display: grid;
  grid-template-columns: repeat(6, 1fr); /* Creates 3 equal-width columns */
  gap: 5px; /* Adds space between grid items (buttons) */
  padding: 5px; /* Optional: adds padding around the entire grid */
}

.button-grid button {
  padding: 5px;
  font-size: 16px;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.button-grid button:hover {
  background-color: #0056b3;
}

.consonants button {
  background-color: #782a4e;
}

.vowels button {
  background-color: #3f5c27;
}

.finals button {
  background-color: #27325c;
}

.tones button {
  background-color: #363636;
}

  </style>
</head>
<body>
<h3>hanzi</h3>
<span id="question"></span>



<div class="button-grid consonants">
  <button>b</button>
  <button>p</button>
  <button>m</button>
  <button>f</button>
  <div></div><div></div>
  
  <button>d</button>
  <button>t</button>
  <button>n</button>
  <button>l</button>
  <div></div><div></div>

  <button>g</button>
  <button>k</button>
  <button>h</button>
  <div></div><div></div><div></div>

  <button>j</button>
  <button>q</button>
  <button>x</button>
  <button>z</button>
  <button>c</button>
  <button>s</button>

  <button>zh</button>
  <button>ch</button>
  <button>sh</button>
  <button>r</button>
  <div></div><div></div>
  
  <button>y</button>
  <button>w</button>
  <div></div><div></div><div></div><div></div>
</div>

<div class="button-grid vowels">
  <button>a</button>
  <button>o</button>
  <button>e</button>
  <button>i</button>
  <button>u</button>
  <button>ü</button>
</div>

<div class="button-grid finals">
  <button>n</button>
  <button>ng</button>
  <button>r</button>
</div>

<div class="button-grid tones">
  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>4</button>
  <button>0</button>
</div>

<button id="clearPinyinBtn">Clear</button>
<button id="submitBtn">Submit</button>
<button id="pinyinBtn">Give Up =(</button>

<div>
  Pinyin: <span id="pinyin"> </span>
</div>

<div id="wrapper">
	<canvas id="canvas" width="300" height="300"></canvas>
	<embed id="animation" src="./common_svgs/我.svg" type="image/svg+xml" style="visibility:hidden; position:absolute; top:0; left:0; width:300px; height:300px; pointer-events:none; opacity:0.3;">
</div>
<div id="controls">
  <button id="checkBtn">Check</button>
  <button id="clearBtn">Clear</button>
  <button id="undoBtn">Undo</button>
  <button id="replayBtn">Replay</button>
  <input id="showChr" type="checkbox"> show/hide character
</div>

<div id="result"></div>

<script src="hanzilookup.min.js"></script>
<script src="https://unpkg.com/pinyin-pro"></script>

<script>
const { pinyin } = pinyinPro;



const gridButtons = document.querySelectorAll('.button-grid button');
const pinyinEl = document.getElementById("pinyin");


gridButtons.forEach(button => {
  button.onclick = () => {
    pinyinEl.innerText += button.textContent;
  }
});



  // Track strokes
  let resultEl = document.getElementById("result")
  
  let strokes = [];
  let currentStroke = [];
  let drawing = false;

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  	ctx.lineWidth = 10;
	ctx.lineCap = 'round';


function drawGrid() {
  const w = canvas.width;
  const h = canvas.height;

  ctx.save();
  ctx.strokeStyle = "#cccccc";
  ctx.lineWidth = 1;

  ctx.clearRect(0, 0, w, h);

  ctx.strokeRect(0, 0, w, h);

  ctx.beginPath();
  ctx.moveTo(w / 2, 0);
  ctx.lineTo(w / 2, h);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(0, h / 2);
  ctx.lineTo(w, h / 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(w, h);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(w, 0);
  ctx.lineTo(0, h);
  ctx.stroke();

  ctx.restore();
}

drawGrid();


  // Get pointer position relative to canvas
  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches) e = e.touches[0];
    return [e.clientX - rect.left, e.clientY - rect.top];
  }

  // Pointer events
  canvas.addEventListener("pointerdown", e => {
    drawing = true;
    currentStroke = [];
    const pos = getPos(e);
    currentStroke.push(pos);
    ctx.beginPath();
    ctx.moveTo(...pos);
    canvas.setPointerCapture(e.pointerId);
  });

  canvas.addEventListener("pointermove", e => {
    if (!drawing) return;
    const pos = getPos(e);
    currentStroke.push(pos);
    ctx.lineTo(...pos);
    ctx.stroke();
  });

  canvas.addEventListener("pointerup", e => {
    if (drawing && currentStroke.length > 1) strokes.push(currentStroke);
    drawing = false;
	recognize();
  });

  canvas.addEventListener("pointerleave", e => {
    if (drawing && currentStroke.length) strokes.push(currentStroke);
    drawing = false;
  });

  // Clear button
document.getElementById("replayBtn").onclick = function() {
  const svg = document.getElementById("animation");
  const url = svg.getAttribute("src");
  svg.setAttribute("src", url);
};

document.getElementById("undoBtn").onclick = () => {
  if (strokes.length === 0) return;       // nothing to undo
  strokes.pop();                          // remove last stroke
  ctx.clearRect(0, 0, canvas.width, canvas.height);  // clear canvas
  drawGrid();                              // redraw grid

  // redraw remaining strokes
  ctx.beginPath();
  for (let stroke of strokes) {
    if (stroke.length === 0) continue;
    ctx.moveTo(...stroke[0]);
    for (let i = 1; i < stroke.length; i++) {
      ctx.lineTo(...stroke[i]);
    }
  }
  ctx.stroke();

  if (strokes.length === 0) {
    resultEl.innerText = '';
	return;
  }
  recognize();
};

function cleardraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  strokes = [];
  drawGrid();
  resultEl.innerText = ''; 
};

document.getElementById("clearBtn").onclick = cleardraw;
document.getElementById("clearPinyinBtn").onclick = () => {
  document.getElementById("pinyin").innerText = ""
}

let matcher = null;

HanziLookup.init('mmah','mmah.json', success => {
  if (!success) { 
    resultEl.innerText = 'Failed to load MMAH data'; 
    return; 
  }
  
  matcher = new HanziLookup.Matcher('mmah');
});

function recognize() {
  const analyzed = new HanziLookup.AnalyzedCharacter(strokes);

  matcher.match(analyzed, 1, matches => {
    if (!matches.length) { 
      resultEl.innerText = 'No matches'; 
      return; 
    }
    resultEl.innerText = `${matches[0]['character']} (score: ${matches[0]['score'].toFixed(3)})`;
  });
}

async function loadShuffledQuestions(url) {
    const resp = await fetch(url);
    const text = await resp.text();
    let lines = text.split(/\r?\n/).filter(x => x.trim());
	lines = lines.map(l => l.split("|"));


    for (let i = lines.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = lines[i];
        lines[i] = lines[j];
        lines[j] = tmp;
    }

    return lines;
}

async function init() {
	const questions = await loadShuffledQuestions("questions.csv");
    console.log(questions);
	let index = 0;
    function nextQuestion() {
        if (index > questions.length) return null;
        const q = questions[index];
        index += 1;
        return q;
    }
	
	function setupQuestion() {
	    const next = nextQuestion();
        if (next) {
            ([question, answer] = next);
            console.log(answer);
        }
		cleardraw();
		document.getElementById("question").innerText = question;
		document.getElementById("showChr").checked = false;
		document.getElementById("pinyin").innerText = '';
	};
	
	setupQuestion();
	
	document.getElementById("checkBtn").onclick = function() {
      const resultEl = document.getElementById("result");
      if (resultEl.innerText[0] === answer) {
        console.log("success!")
		setupQuestion();
      }
	};

	document.getElementById("pinyinBtn").onclick = function() {
      const pinyinEl = document.getElementById("pinyin");
      pinyinEl.innerText = pinyin(answer, { toneType: 'num' });
	};

	document.getElementById("showChr").addEventListener("change", function() {
	  const anim = document.getElementById("animation");
	  if (this.checked) {
		anim.style.visibility = "visible";
		const svg = document.getElementById("animation");
		svg.setAttribute("src", `./common_svgs/${answer}.svg`);
	  } else {
		anim.style.visibility = "hidden";
	  }
	});
	
	document.getElementById("submitBtn").onclick = () => {
	  const pinyinEl = document.getElementById("pinyin");
	  if (pinyin(answer, { toneType: 'num' }) === pinyinEl.innerText) {
	    console.log("Good job on the pinyin!");
      } else {
	    console.log("haha idiot");
	  }
	}
}

init();
</script>

</body>
</html>
