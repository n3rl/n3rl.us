<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta charset="UTF-8">
  <title>Hanzi</title>
  <style>
    #canvas {
      border: 1px solid black;
      touch-action: none;
    }
    #controls {
      margin-top: 10px;
    }
	
	#wrapper {
  position: relative;
  width: 300px;
  height: 300px;
}

.button-grid {
  width: 400px;
  display: grid;
  grid-template-columns: repeat(6, 1fr); /* Creates 3 equal-width columns */
  gap: 5px; /* Adds space between grid items (buttons) */
  padding: 5px; /* Optional: adds padding around the entire grid */
}

.button-grid button {
  padding: 4px;
  font-size: 16px;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
  margin-right: 20px;
}

.button-grid button:hover {
  background-color: #0056b3;
}

.consonants button {
  background-color: #782a4e;
}

.vowels button {
  background-color: #3f5c27;
}

.finals button {
  background-color: #27325c;
}

.tones button {
  background-color: #363636;
}


.button-grid button:disabled {
    background-color: #cccccc; /* Gray background */
    color: #666666;             /* Darker text color */
    cursor: not-allowed;        /* "Not allowed" cursor icon */
    opacity: 0.6;               /* Reduced opacity to visually indicate inactivity */
}

.button-grid button:hover:not(:disabled) {
    background-color: #0056b3;
}




.main-layout {
  display: flex;
  gap: 20px;
  align-items: flex-start;
}

#canvas-area {
  flex: 0 0 auto;
}

#pinyin-area {
  flex: 1;
}

#wrapper {
  position: relative;
}

#checkBtn {
  margin-right: 60px;
  margin-bottom: 30px;
}

#submitBtn {
  margin-right: 60px;
  margin-bottom: 30px;
}

  </style>
</head>
<body>
<h3>hanzi</h3>
example sentences come from <a href="https://www.pinhok.com/kb/for-hsk/1138/hsk-1-example-sentences/">here</a>, any weirdness is their fault
<button id="nextBtn">Next</button><span id="question"></span>

<div class="main-layout">
  <!-- Left: canvas + controls -->
  <div id="canvas-area">
    <div id="wrapper">
      <canvas id="canvas" width="300" height="300"></canvas>
      <embed id="animation" type="image/svg+xml"
        style="visibility:hidden; position:absolute; top:0; left:0; width:300px; height:300px; pointer-events:none; opacity:0.3;">
    </div>

    <div id="controls">
      <button id="checkBtn">Check</button>
      <button id="undoBtn">Undo</button>
      <button id="clearBtn">Clear</button>
    </div>
	<div>Predicted: <span id="result"></span></div>
	<input id="showChr" type="checkbox"> show/hide character
    <button id="replayBtn">Replay</button>
  </div>

  <!-- Right: button grids -->
  <div id="pinyin-area">
<div class="button-grid consonants">
  <button>b</button>
  <button>p</button>
  <button>m</button>
  <button>f</button>
  <div></div><div></div>
  
  <button>d</button>
  <button>t</button>
  <button>n</button>
  <button>l</button>
  <div></div><div></div>

  <button>g</button>
  <button>k</button>
  <button>h</button>
  <div></div><div></div><div></div>

  <button>j</button>
  <button>q</button>
  <button>x</button>
  <button>z</button>
  <button>c</button>
  <button>s</button>

  <button>zh</button>
  <button>ch</button>
  <button>sh</button>
  <button>r</button>
  <div></div><div></div>
  
  <button>y</button>
  <button>w</button>
  <div></div><div></div><div></div><div></div>
</div>

<div class="button-grid vowels">
  <button>a</button>
  <button>o</button>
  <button>e</button>
  <button>i</button>
  <button>u</button>
  <button>Ã¼</button>
</div>

<div class="button-grid finals">
  <button>n</button>
  <button>ng</button>
  <button>r</button>
</div>

<div class="button-grid tones">
  <button>1</button>
  <button>2</button>
  <button>3</button>
  <button>4</button>
  <button>0</button>
</div>

    <button id="submitBtn">Submit</button>
    <button id="clearPinyinBtn">Clear</button>
    


    <div>Pinyin: <span id="pinyin"></span></div>
    <button id="pinyinBtn">Give Up =(</button>
  </div>
</div>

<script src="hanzilookup.min.js"></script>
<script src="https://unpkg.com/pinyin-pro"></script>

<script>
const { pinyin } = pinyinPro;

// correct hanzi/pinyin, incorrect hanzi/pinyin
var score = [0, 0]

const gridButtons = document.querySelectorAll('.button-grid button');
const pinyinEl = document.getElementById("pinyin");


gridButtons.forEach(button => {
  button.onclick = () => {
    pinyinEl.innerText += button.textContent;
  }
});



  // Track strokes
  let resultEl = document.getElementById("result")
  
  let strokes = [];
  let currentStroke = [];
  let drawing = false;

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");
  	ctx.lineWidth = 10;
	ctx.lineCap = 'round';


function drawGrid() {
  const w = canvas.width;
  const h = canvas.height;

  ctx.save();
  ctx.strokeStyle = "#cccccc";
  ctx.lineWidth = 1;

  ctx.clearRect(0, 0, w, h);

  ctx.strokeRect(0, 0, w, h);

  ctx.beginPath();
  ctx.moveTo(w / 2, 0);
  ctx.lineTo(w / 2, h);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(0, h / 2);
  ctx.lineTo(w, h / 2);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(0, 0);
  ctx.lineTo(w, h);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(w, 0);
  ctx.lineTo(0, h);
  ctx.stroke();

  ctx.restore();
}

drawGrid();


  // Get pointer position relative to canvas
  function getPos(e) {
    const rect = canvas.getBoundingClientRect();
    if (e.touches) e = e.touches[0];
    return [e.clientX - rect.left, e.clientY - rect.top];
  }

  // Pointer events
  canvas.addEventListener("pointerdown", e => {
    drawing = true;
    currentStroke = [];
    const pos = getPos(e);
    currentStroke.push(pos);
    ctx.beginPath();
    ctx.moveTo(...pos);
    canvas.setPointerCapture(e.pointerId);
  });

  canvas.addEventListener("pointermove", e => {
    if (!drawing) return;
    const pos = getPos(e);
    currentStroke.push(pos);
    ctx.lineTo(...pos);
    ctx.stroke();
  });

  canvas.addEventListener("pointerup", e => {
    if (drawing && currentStroke.length > 1) strokes.push(currentStroke);
    drawing = false;
	recognize();
  });

  canvas.addEventListener("pointerleave", e => {
    if (drawing && currentStroke.length) strokes.push(currentStroke);
    drawing = false;
  });

  // Clear button
document.getElementById("replayBtn").onclick = function() {
  const svg = document.getElementById("animation");
  const url = svg.getAttribute("src");
  svg.setAttribute("src", url);
};

document.getElementById("undoBtn").onclick = () => {
  if (strokes.length === 0) return;       // nothing to undo
  strokes.pop();                          // remove last stroke
  ctx.clearRect(0, 0, canvas.width, canvas.height);  // clear canvas
  drawGrid();                              // redraw grid

  // redraw remaining strokes
  ctx.beginPath();
  for (let stroke of strokes) {
    if (stroke.length === 0) continue;
    ctx.moveTo(...stroke[0]);
    for (let i = 1; i < stroke.length; i++) {
      ctx.lineTo(...stroke[i]);
    }
  }
  ctx.stroke();

  if (strokes.length === 0) {
    resultEl.innerText = '';
	return;
  }
  recognize();
};

function cleardraw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  strokes = [];
  drawGrid();
  resultEl.innerText = ''; 
};

var giveUpPinyin = false;
var giveUpHanzi = false;
var correctPinyin = false;
var correctHanzi = false;

document.getElementById("clearBtn").onclick = cleardraw;
document.getElementById("clearPinyinBtn").onclick = () => {
  if (!giveUpPinyin && !correctPinyin) document.getElementById("pinyin").innerText = "";
}

let matcher = null;

HanziLookup.init('mmah','mmah.json', success => {
  if (!success) { 
    resultEl.innerText = 'Failed to load MMAH data'; 
    return; 
  }
  
  matcher = new HanziLookup.Matcher('mmah');
});

function recognize() {
  const analyzed = new HanziLookup.AnalyzedCharacter(strokes);

  matcher.match(analyzed, 1, matches => {
    if (!matches.length) { 
      resultEl.innerText = 'No matches'; 
      return; 
    }
    resultEl.innerText = `${matches[0]['character']} (score: ${matches[0]['score'].toFixed(3)})`;
  });
}

async function loadShuffledQuestions(url) {
    const resp = await fetch(url);
    const text = await resp.text();
    let lines = text.split(/\r?\n/).filter(x => x.trim());
	lines = lines.map(l => l.split("|"));


    for (let i = lines.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        const tmp = lines[i];
        lines[i] = lines[j];
        lines[j] = tmp;
    }

    return lines;
}

async function init() {
	const questions = await loadShuffledQuestions("questions.csv");
    console.log(questions);
	let index = 0;
    function nextQuestion() {
        if (index > questions.length) return null;
        const q = questions[index];
        index += 1;
        return q;
    }
	
	function setupQuestion() {
		giveUpPinyin = false;
		giveUpHanzi = false;
		correctHanzi = false;
		correctPinyin = false;
	    gridButtons.forEach(button => {
	      button.disabled = false;
	    });
	    const next = nextQuestion();
        if (next) {
            ([question, answer] = next);
            console.log(answer);
        }
		cleardraw();
		document.getElementById("question").innerText = question;
		document.getElementById("showChr").checked = false;
		document.getElementById("pinyin").innerText = '';
		
		const anim = document.getElementById("animation");
		anim.style.visibility = "hidden";
		document.getElementById("canvas-area").style.background = ""
		document.getElementById("pinyin-area").style.background = ""
		
		document.getElementById("nextBtn").disabled = true;

	};
	
	document.getElementById("nextBtn").onclick = setupQuestion;
	
	setupQuestion();
	
	document.getElementById("checkBtn").onclick = function() {
      const resultEl = document.getElementById("result");
      if (resultEl.innerText[0] === answer) {
        console.log("success!")
		correctHanzi = true;
		if (correctPinyin || giveUpPinyin) {
		  document.getElementById("nextBtn").disabled = false;
		}
		if (!giveUpHanzi) {
		  document.getElementById("canvas-area").style.background = "#189229"
		}
		if (giveUpHanzi) {
		  document.getElementById("canvas-area").style.background = "#a71b1b";
		}
      } else {
	    if (correctHanzi) return;
	    console.log("you suck at writing hanzi");
		giveUpHanzi = true;
		showHanzi();
	  }
	};
	
	function showPinyin() {
	  if (correctPinyin) return;
	  console.log("showing you the pinyin cause you're too stupid to remember it lmao");
      const pinyinEl = document.getElementById("pinyin");
      pinyinEl.innerText = pinyin(answer, { toneType: 'num' });
	  giveUpPinyin = true;
	  gridButtons.forEach(button => {
	    button.disabled = true;
	  });
	  document.getElementById("pinyin-area").style.background = "#a71b1b";
	  
	  if (correctHanzi) document.getElementById("nextBtn").disabled = false;

	};

	document.getElementById("pinyinBtn").onclick = showPinyin

	function showHanzi() {
	  const anim = document.getElementById("animation");
	  if (!correctHanzi) {
        score[2] += 1;
	    document.getElementById("canvas-area").style.background = "#ffd22e";
	  }
	  anim.style.visibility = "visible";
	  const svg = document.getElementById("animation");
	  svg.setAttribute("src", `./common_svgs/${answer}.svg`);
	  document.getElementById("showChr").checked = true;
	}

	document.getElementById("showChr").addEventListener("change", function() {
	  if (!correctHanzi) giveUpHanzi = true;
	  const anim = document.getElementById("animation");
	  if (this.checked) {
        showHanzi();
		document.getElementById("replayBtn").style.visibility = "";
	  } else {
		anim.style.visibility = "hidden";
		document.getElementById("replayBtn").style.visibility = "hidden";
	  }
	});
	
	document.getElementById("submitBtn").onclick = () => {
	  const pinyinEl = document.getElementById("pinyin");
	  if (pinyin(answer, { toneType: 'num' }) === pinyinEl.innerText && !correctPinyin) {
	    if (giveUpPinyin) {
		  console.log("well you cheated on the pinyin...");
		} else {
	      console.log("Good job on the pinyin!");
		  document.getElementById("pinyin-area").style.background = "#189229"
		  score[1] += 1;
		}
	    gridButtons.forEach(button => {
	      button.disabled = true;
	    });
		correctPinyin = true;
		if (correctHanzi) document.getElementById("nextBtn").disabled = false;
      } else {
	    console.log("haha idiot");
		showPinyin();
	  }
	}
}

init();
</script>

</body>
</html>
